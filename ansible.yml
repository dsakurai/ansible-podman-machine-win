---
- name: Set up podman machine on WSL2
  hosts: localhost

  tasks:
    - name: install neovim
      become: true
      apt:
        name: neovim

    - name: Cycle bash completion with TAB
      blockinfile:
        block: |
          TAB: menu-complete
          "\e[Z": menu-complete-backward
          set editing-mode vi
          set keymap vi-command
          "\C-l": clear-screen
          set keymap vi-insert
          "\C-l": clear-screen
        dest: ~/.inputrc
        create: true

    - name: install podman-compose
      become: true
      apt:
        name: podman-compose

    - name: git set up
      shell: git config --global init.defaultBranch main
    
    - name: ssh
      block:
        - name: ensure directory exits
          file:
            path: "~/.ssh"
            state: directory
            mode: "0700"
        - name: ssh agent
          blockinfile:
            create: true
            path: ~/.ssh/config
            block: |
              AddKeysToAgent yes
              IdentityAgent /run/user/1000/ssh-agent.socket

        - name: ensure directory exits
          file:
            dest: "~/.config/systemd/user"
            state: directory
            mode: "0700"
        - name: Install ssh-agent user service
          copy:
            dest: "~/.config/systemd/user/ssh-agent.service"
            mode: "0644"
            content: |
              [Unit]
              Description=SSH Agent

              [Service]
              Type=simple
              # Fixed socket in the user's runtime dir:
              ExecStart=/usr/bin/ssh-agent -D -a %t/ssh-agent.socket
              # Optional security hardening:
              PrivateTmp=yes
              NoNewPrivileges=yes

              [Install]
              WantedBy=default.target

        - name: Reload user systemd daemon
          command: systemctl --user daemon-reload

        - name: Enable and start ssh-agent user service
          command: systemctl --user enable --now ssh-agent.service


        # - name: Enable lingering
        #   command: "loginctl enable-linger"


